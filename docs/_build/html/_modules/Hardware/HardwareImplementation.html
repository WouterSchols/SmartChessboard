
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hardware.HardwareImplementation &#8212; Smart Chess Board 1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Smart Chess Board 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Hardware.HardwareImplementation</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Hardware.HardwareImplementation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">chess</span>
<span class="kn">from</span> <span class="nn">Hardware</span> <span class="kn">import</span> <span class="n">HardwareInterface</span><span class="p">,</span> <span class="n">SafeDecorator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">import</span> <span class="nn">board</span>
<span class="kn">import</span> <span class="nn">busio</span>
<span class="kn">import</span> <span class="nn">digitalio</span>
<span class="kn">import</span> <span class="nn">adafruit_tca9548a</span>
<span class="kn">import</span> <span class="nn">adafruit_character_lcd.character_lcd_i2c</span> <span class="k">as</span> <span class="nn">character_lcd</span>
<span class="kn">from</span> <span class="nn">adafruit_ht16k33</span> <span class="kn">import</span> <span class="n">matrix</span>
<span class="kn">from</span> <span class="nn">adafruit_mcp230xx.mcp23017</span> <span class="kn">import</span> <span class="n">MCP23017</span>


<div class="viewcode-block" id="HardwareImplementation"><a class="viewcode-back" href="../../Hardware.html#Hardware.HardwareImplementation.HardwareImplementation">[docs]</a><span class="k">class</span> <span class="nc">HardwareImplementation</span><span class="p">(</span><span class="n">HardwareInterface</span><span class="o">.</span><span class="n">HardwareInterface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Interface to Hardware chessboard&quot;&quot;&quot;</span>

    <span class="n">_board_reed</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
    <span class="n">_perform_safe</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set up hardware connection</span>

<span class="sd">        Sets up connections to the following bus devices over the i2c bus:</span>
<span class="sd">        - Sets up a TCA9548a to handle the high traffic load on the bus</span>
<span class="sd">        - Sets up a 8x8 reed_matrix mapped trough 4 MCP23017</span>
<span class="sd">        - Sets up a 9x9 led_matrix with the interface LedWrapper which uses a HT16k33 and 1 MCP23017</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i2c</span> <span class="o">=</span> <span class="n">busio</span><span class="o">.</span><span class="n">I2C</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">SCL</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">SDA</span><span class="p">)</span>
        <span class="n">tca</span> <span class="o">=</span> <span class="n">adafruit_tca9548a</span><span class="o">.</span><span class="n">TCA9548A</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="mh">0x71</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span> <span class="o">=</span> <span class="n">SafeDecorator</span><span class="o">.</span><span class="n">perform_safe_factory</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">tca</span><span class="o">.</span><span class="n">i2c</span><span class="p">,</span> <span class="s1">&#39;_locked&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lcd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">character_lcd</span><span class="o">.</span><span class="n">Character_LCD_I2C</span><span class="p">(</span><span class="n">tca</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="mh">0x27</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">setattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lcd</span><span class="p">,</span> <span class="s2">&quot;backlight&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">mcp</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">MCP23017</span><span class="p">(</span><span class="n">tca</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="mh">0x20</span><span class="p">))(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>

        <span class="c1"># Initialize reed matrix</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="n">pin_id</span> <span class="o">=</span> <span class="n">file</span> <span class="k">if</span> <span class="n">rank</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">15</span> <span class="o">-</span> <span class="n">file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_board_reed</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="n">rank</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="n">mcp</span><span class="p">[</span><span class="n">rank</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_pin</span><span class="p">)(</span><span class="n">pin_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">setattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_board_reed</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="n">rank</span><span class="p">],</span> <span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">Direction</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">setattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_board_reed</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="n">rank</span><span class="p">],</span> <span class="s2">&quot;pull&quot;</span><span class="p">,</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">Pull</span><span class="o">.</span><span class="n">UP</span><span class="p">)</span>

        <span class="n">led_input_mcp</span> <span class="o">=</span> <span class="n">MCP23017</span><span class="p">(</span><span class="n">tca</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="mh">0x20</span><span class="p">)</span>
        <span class="c1"># Map output buttons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pinId</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="n">led_input_mcp</span><span class="o">.</span><span class="n">get_pin</span><span class="p">)(</span><span class="n">pinId</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">setattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">Direction</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">setattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;pull&quot;</span><span class="p">,</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">Pull</span><span class="o">.</span><span class="n">UP</span><span class="p">)</span>

        <span class="c1"># Initialize LED matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_led_wrapper</span> <span class="o">=</span> <span class="n">LedWrapper</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">MatrixBackpack16x8</span><span class="p">(</span><span class="n">tca</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="n">led_input_mcp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_led_wrapper</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Turn of LED before shutting down &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_led_wrapper</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="HardwareImplementation.mark_squares"><a class="viewcode-back" href="../../Hardware.html#Hardware.HardwareImplementation.HardwareImplementation.mark_squares">[docs]</a>    <span class="k">def</span> <span class="nf">mark_squares</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squares</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Marks squares on the chessboard where squares is an 8x8 matrix implemented as a 2s list</span>

<span class="sd">        Note that squares are mapped as squares[file][rank] ie. a1 = squares[0][0], a2 = squares[0][1], \</span>
<span class="sd">        b1 = squares[1][0] and h8 is squares[7][7]</span>

<span class="sd">        :param squares: 8x8 matrix of squares to mark on the chessboard where square [file][rank] \</span>
<span class="sd">        is marked if square[file][rank] == TRUE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_led_wrapper</span><span class="o">.</span><span class="n">set_squares</span><span class="p">(</span><span class="n">squares</span><span class="p">)</span></div>

<div class="viewcode-block" id="HardwareImplementation.get_occupancy"><a class="viewcode-back" href="../../Hardware.html#Hardware.HardwareImplementation.HardwareImplementation.get_occupancy">[docs]</a>    <span class="k">def</span> <span class="nf">get_occupancy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot; Returns all occupied squares as 8x8 matrix implemented as a 2d list</span>

<span class="sd">        Note that squares are mapped as squares[file][rank] so if square a2 is occupied then get_occupancy[0][1] is TRUE</span>

<span class="sd">        :return: 8x8 matrix with all occupied squares on the chessboard</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_board_reed</span><span class="p">:</span>
            <span class="n">result_file</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">square</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">result_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="n">square</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">))</span>  <span class="c1"># result_file += [not square.value]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="HardwareImplementation.promotion_piece"><a class="viewcode-back" href="../../Hardware.html#Hardware.HardwareImplementation.HardwareImplementation.promotion_piece">[docs]</a>    <span class="k">def</span> <span class="nf">promotion_piece</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">chess</span><span class="o">.</span><span class="n">Piece</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Which piece to promote to</span>

<span class="sd">        Reads input button to select promotion piece, writes selected piece to display and waits for confirmation</span>

<span class="sd">        :return: Piece to promote to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">piece</span> <span class="o">=</span> <span class="n">chess</span><span class="o">.</span><span class="n">QUEEN</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                <span class="n">piece</span> <span class="o">=</span> <span class="n">chess</span><span class="o">.</span><span class="n">QUEEN</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                <span class="n">piece</span> <span class="o">=</span> <span class="n">chess</span><span class="o">.</span><span class="n">ROOK</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                <span class="n">piece</span> <span class="o">=</span> <span class="n">chess</span><span class="o">.</span><span class="n">BISHOP</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                <span class="n">piece</span> <span class="o">=</span> <span class="n">chess</span><span class="o">.</span><span class="n">KNIGHT</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">chess</span><span class="o">.</span><span class="n">piece_name</span><span class="p">(</span><span class="n">piece</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">piece</span></div>

<div class="viewcode-block" id="HardwareImplementation.game_end_offers"><a class="viewcode-back" href="../../Hardware.html#Hardware.HardwareImplementation.HardwareImplementation.game_end_offers">[docs]</a>    <span class="k">def</span> <span class="nf">game_end_offers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HardwareInterface</span><span class="o">.</span><span class="n">Offer</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Returns continue, draw or return offers</span>

<span class="sd">        If no button pressed returns continue, otherwise wait for confirmation</span>

<span class="sd">        :return: Always returns continue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">HardwareInterface</span><span class="o">.</span><span class="n">Offer</span><span class="o">.</span><span class="n">RESIGN</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">HardwareInterface</span><span class="o">.</span><span class="n">Offer</span><span class="o">.</span><span class="n">CONTINUE</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">HardwareInterface</span><span class="o">.</span><span class="n">Offer</span><span class="o">.</span><span class="n">DRAW</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">getattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buttons</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">HardwareInterface</span><span class="o">.</span><span class="n">Offer</span><span class="o">.</span><span class="n">DRAW</span>
        <span class="k">return</span> <span class="n">HardwareInterface</span><span class="o">.</span><span class="n">Offer</span><span class="o">.</span><span class="n">CONTINUE</span></div>

<div class="viewcode-block" id="HardwareImplementation.display"><a class="viewcode-back" href="../../Hardware.html#Hardware.HardwareImplementation.HardwareImplementation.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Displays text string on hardware</span>

<span class="sd">        :param txt: text to display on hardware</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="n">set_attr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lcd</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LedWrapper"><a class="viewcode-back" href="../../Hardware.html#Hardware.HardwareImplementation.LedWrapper">[docs]</a><span class="k">class</span> <span class="nc">LedWrapper</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;&quot; Wraps LED hardware &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ht16k33</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">MatrixBackpack16x8</span><span class="p">,</span> <span class="n">mcp</span><span class="p">:</span> <span class="n">MCP23017</span><span class="p">,</span> <span class="n">perform_safe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initializes the led matrix using the ht16k33 and MCP23017</span>

<span class="sd">        :param ht16k33: ht16k33 instance controlling a 8x9 led matrix</span>
<span class="sd">        :param mcp: MCP23017 instance controlling the left most row of LED</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ht16k33</span> <span class="o">=</span> <span class="n">ht16k33</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span> <span class="o">=</span> <span class="n">perform_safe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">mcp</span><span class="o">.</span><span class="n">get_pin</span><span class="p">(</span><span class="n">i</span><span class="p">))(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">setattr</span><span class="p">)(</span><span class="n">pin</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">Direction</span><span class="o">.</span><span class="n">OUTPUT</span><span class="p">)</span>  <span class="c1"># pin.direction = OUTPUT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">setattr</span><span class="p">)(</span><span class="n">pin</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># pin.value = False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="LedWrapper.clear"><a class="viewcode-back" href="../../Hardware.html#Hardware.HardwareImplementation.LedWrapper.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clears all square on the chessboard &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ht16k33</span><span class="o">.</span><span class="n">fill</span><span class="p">)(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># squares.fill(0)</span>
        <span class="k">for</span> <span class="n">led</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">setattr</span><span class="p">)(</span><span class="n">led</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># led.value = False</span></div>

<div class="viewcode-block" id="LedWrapper.set_squares"><a class="viewcode-back" href="../../Hardware.html#Hardware.HardwareImplementation.LedWrapper.set_squares">[docs]</a>    <span class="k">def</span> <span class="nf">set_squares</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">squares</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]):</span>
        <span class="sd">&quot;&quot;&quot; Marks squares on the chessboard</span>

<span class="sd">        Improvement on calling clear() then marking all squires since this prevents a flickering of the LED</span>

<span class="sd">        :param squares: 8x8 matrix with the squares to be marked</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">set_led</span><span class="p">(</span><span class="n">rank</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Turn LED at position rank, file on iff val</span>

<span class="sd">            :param rank: rank of LED to turn</span>
<span class="sd">            :param file: file of LED to turn</span>
<span class="sd">            :param val: turns on LED iff val is True</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ht16k33</span><span class="p">[</span><span class="n">rank</span><span class="p">,</span> <span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
                <span class="c1"># Check of LED should be turned on</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">file</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">squares</span><span class="p">[</span><span class="n">file</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">rank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">file</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">squares</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="n">rank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">file</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">squares</span><span class="p">[</span><span class="n">file</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">rank</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">file</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">squares</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="n">rank</span><span class="p">]</span>

                <span class="c1"># Turn LED on or off</span>
                <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="nb">setattr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_column</span><span class="p">[</span><span class="mi">8</span> <span class="o">-</span> <span class="n">rank</span><span class="p">],</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                                                <span class="n">value</span><span class="p">)</span>  <span class="c1"># _column[8 - rank].value = True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_perform_safe</span><span class="p">(</span><span class="n">set_led</span><span class="p">)(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">rank</span><span class="p">,</span> <span class="n">file</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># _ht16k33[7 - rank][file - 1]=True</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Smart Chess Board 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Hardware.HardwareImplementation</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Wouter Schols.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.4.
    </div>
  </body>
</html>